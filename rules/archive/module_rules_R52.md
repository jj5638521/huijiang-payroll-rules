计算工资模块 TXT（#52 全量｜v2025-11-25R52）
——仅新增“固定日薪映射（内置）”；其余规则、逻辑、文本与格式同#51——

1｜版本
- 版本序号：#52
- 内部标签：v2025-11-25R52-FixedDailyRates
- 变更纪要（仅新增 H，A–G 沿用#51）：
  A. AttendancePipe 表头清洗与多名映射（日期/姓名/项目名/是否施工/车辆列）
  B. Project 识别（多项目表/单项目表兜底/冲突阻断）
  C. PaymentPipe 有效状态/类别分流/凭证唯一/复用风险阻断
  D. 工作形态判定（单防撞 vs 全组）与车组粒度收口
  E. 计价规则（全组/单防撞出勤与未出勤）
  F. 餐补规则（全组参与；单防撞恒0；未供餐口令兜底）
  G. 输出模板与校核（v18详细版+压缩版；Hard阻断）
  H. 新增：固定日薪映射（内置，只读）——写入“个人单价_统一”

2｜总则
- 仅办理“按人出单”；语言=中文；结构化、零废话、便于截图复制。
- 输出固定两段纯文字：①【详细版（给杰对账）】= v18模板 + 文末“日期（模式→出勤）”；②【压缩版】= 单人压缩模板（0值整段隐藏）。
- 严禁生成下载链接/附件；元数据JSON仅在另行指令时以代码块输出。
- 严格“二管道隔离”：AttendancePipe（考勤）与 PaymentPipe（支付/报销）互不读对方字段。

3｜适用口令
- 单人出单：工资：{姓名} {角色} 项目已结束={是|否}（仅此人，不扩组/不全项目）。
- 动态口令（运行期追加）：
  · 设置固定日薪=姓名:金额 → 个人单价_统一
  · 设置单防撞日薪=姓名:金额 → 个人单价_单防撞
  · 确认施工未供餐=YYYY-MM-DD,…（仅全组“出勤→40”）
  · 确认未施工无餐补=YYYY-MM-DD,…（仅全组“未施工→0”）
  · 项目=XXX（单项目表兜底指定）

4｜AttendancePipe（读取/表头兼容）
4.1 表头清洗
- 去空白/制表符；全角转半角；统一大小写；去BOM/隐藏换行。
4.2 字段映射（取首个非空列）
- 日期 ← 日期 | 施工日期 | 工作日期
- 姓名 ← 姓名 | 人员 | 施工人员 | 实际施工人员
- 项目名 ← 项目 | 项目名 | 项目名称
- 是否施工 ← 列名包含“是否施工”
- 车辆列（任一）← 车辆 | 车牌 | 车牌号 | 车辆名称 | 车辆类型
4.3 缺字段处理
- “表头清洗＋多名映射”后仍找不到关键列 → 报缺字段并 Hard 阻断。

5｜Project识别
5.1 多项目表
- 任一管道存在项目列 → 严格按列分项目，禁止覆盖。
5.2 单项目表兜底
- 两管道均无项目列时，兜底顺序：
  口令项目=XXX ＞ 文件名解析（去扩展名与常见后缀 _数据表_数据/_考勤）＞ 仍失败则“缺项目名”阻断。
5.3 冲突处理（P1）
- 若一管道为多项目表、另一管道为单项目表：单项目表需兜底且与主控项目集合一一对应，否则阻断。
- 两管道均为单项目且解析不一致：提示用“项目=XXX”并阻断。

6｜PaymentPipe（识别与归集）
6.1 别名归一
- 类别 ← 报销类型 | 费用类型
- 凭证号 ← 凭证号 | 上传凭证 | 票据号
6.2 有效状态
- 仅“已支付/已转账/已报销/完成/通过/成功/OK”等计入；其余进入“待确认清单”，不计入。
6.3 类别分流
- 工资类（类别=工资）：状态有效且姓名匹配 → 全部计入个人“已付工资”，并参与当期应付扣减；备注疑似跨项目/项目不明不影响扣减（但需险情提示）。
- 工资预支（类别=工资预支）：计入个人“预支”；备注含“预支X天”按单价分段逐日换算。
- 餐补类：计入个人“已付/预支”（按类别定义）。
- 路费类（油费/ETC/打车/网约车等）：为项目费用，不等同“路补”。
6.4 结清有效期关闭
- 仅按“姓名+项目”合并全表有效款项（不按日期过滤）。
6.5 凭证唯一
- {凭证号|TEMP}+日期+金额 唯一；
- 凭证空且（姓名,项目,日期,金额,状态有效）五元组唯一 → 生成TEMP参与对账，禁止回写源表。
6.6 复用风险（P2）
- 同一〈姓名+项目〉若备注/凭证显跨批次（如“再次结清/第二次/补发上次/多月段”）→ Hard 阻断并输出《待确认清单》，要求“项目=XXX”或拆分支付数据后重算。

7｜工作形态判定（单防撞 vs 全组｜唯一入口）
7.1 定义
- N_work(项目×日期)=当日“是否施工=是”的去重人数；
- V_crash=车辆字段含“防撞/防撞车”；V_other=含“设标/标线/标志/施工车/清障/拖车”等；
- 车组粒度岗位人数 N_role(车组×日期)=该车组当日【岗位列非空】的去重人数；
7.2 驾驶员约束（单防撞准入）
- Driver=当日该车组“防撞车驾驶员”列非空且可映射到姓名；
- Assistant=当日该车组辅助列（辅助1/辅助2/辅助）非空且去重人数≤1；
- 允许组合：{Driver} 或 {Driver+1 Assistant}；其余任何人员不得归入单防撞集合。
7.3 单防撞候选
- 是否施工=是 ∧ V_crash=1 ∧ V_other=0 ∧ 车组满足驾驶员约束（Driver存在且组合合法）。
7.4 车组×日期收口（防误归类）
- 若该车组满足“单防撞候选”且 N_role∈{1,2} 且组合合法 → 认定【该车组=单防撞大类】：
  · Driver/（可选）Assistant：按“单防撞｜出勤/未出勤”（仍以个人是否施工判定出勤/未出勤）。
  · 同日同项目的其他车组/其他人员：一律按【全组大类】走“全组｜出勤/未出勤”。
- 若该车组 N_role≥3 或组合不合法（无Driver却出现辅助/其他岗位，或辅助≥2，或混入非允许岗位） → 该车组强制【全组大类】。
- 同一车组×日期：禁止单防撞与全组混用（车组内收口）。
7.5 未施工归类
- 先以“人＋日期”定是否施工；
- 未施工人员仅在其所属大类（单防撞或全组）内分流；
- 禁止用“未施工40”改写分类。
7.6 P3 兜底
- 当日施工=是但车辆列缺失/不可判定 → 不猜，强制归【全组大类】继续计算。

8｜计价规则
8.1 全组日薪优先级
- 个人单价_统一 ＞ 项目口径 ＞ 角色默认（组长300/组员200）＞ 系统默认；
- 全组未施工工资=0。
8.2 单防撞日薪（出勤/未出勤）优先级
- 出勤 D_single_yes = 个人单价_单防撞 ＞ 个人单价_统一 ＞ 项目口径_单防撞 ＞ 270；
- 未出勤 D_single_no = round(D_single_yes × 0.5)（元）；
- 单防撞餐补恒=0，禁止叠加。
8.3 固定日薪映射（内置→个人单价_统一）
- 见“附表A｜固定日薪映射（内置，只读）”。

9｜餐补规则（仅全组参与；单防撞恒0）
9.1 未施工（待命）
- 默认40/天；
- 如备注点名“无需算饭补/饭补0/餐自理不补”等 → 该人当日改为0。
- 口令“确认未施工无餐补=YYYY-MM-DD,… ”：仅全组“未施工→0”（按口令日期覆盖）。
9.2 施工
- 默认25/天；
- 若〈项目×日期×组别〉命中“未供餐/没管饭/未提供工作餐/工作餐之内的”等 → 当日所有“施工=是”的同组人员统一提至40；
- 无组别列时按车牌/组别映射划分。
- 口令“确认施工未供餐=YYYY-MM-DD,… ”：仅全组“出勤→40”（按口令日期覆盖）。
9.3 人名匹配与一致性
- 人名匹配逐人生效，禁止“整组外溢”。
- 同日同车组原则上不应25/40混用（“点名归0/清零”除外），混用 → 险情提示。

10｜路补规则
- 项目制一次性结算，封顶200/人/项目；
- 仅“项目已结束=是 且 声明有路补”时计入；
- 不与路费类报销重复入账。

11｜输出（固定形态）
11.1 详细版（v18模板）
- 不改版式，仅在页尾追加“日期（按模式→出勤；跨月换行；空类不打印）”：
  · 单防撞车｜出勤（|S_yes_single|天）：{YYYY-MM：DD、…}
  · 单防撞车｜未出勤（|S_no_single|天）：{…或“无”}
  · 全组｜出勤（|S_yes_group|天）：{…}
  · 全组｜未出勤（|S_no_group|天）：{…或“无”}
11.2 压缩版（单人）
- 为0整段隐藏；
- 仅打印两排日期并置于末行：
  日期（出勤）：{YYYY-MM：DD、…}
  日期（待命）：{YYYY-MM：DD、…}
- 算式零项省略：当期应付 = 工资 ＋ 餐补 （＋路补） − 已付（禁止出现“＋0/−0/×0”）。

12｜校核与阻断（Hard）
- A资料完整；B项目缺失兜底失败；C凭证唯一失败（含TEMP冲突）；D出勤一致性（同人同日冲突/去重异常）；E应付反算不一致；F模式混合（同〈项目×日期〉出现单防撞与全组并存）；G金额未数值化；
- H压缩版日期分行校核：压缩版“日期（出勤/待命）”分别等于详细版对应分类集合；不得打印空分类或合并为一行；跨月换行一致。H’压缩版版式不符；H’’算式零项未省略；M单防撞缺参（已触发候选却信息不足）。
- 仅当“表头清洗＋多名映射＋Project兜底”均失败后方可报缺失；字段存在不得误报。

13｜#54 硬规则层（优先级最高）
0）铁律：姓名=源表字符串原样；不改源表/不补日期；两版一致；压缩版必须“出勤/待命”两排、金额数值化、禁止“×0/0元”。
1）人日证据=出现于任一岗位列/实际出勤列（设标车驾驶员、防撞车驾驶员、辅助1/2、其他岗位列、实际出勤人员）。自动字段（组长(自动)/班组(自动)/系统生成）仅提示，不计钱。
2）日期三分组（按人去重）：
  ①计工资出勤：是否施工=是 且 岗位列命中→计工资+餐补；
  ②待命：是否施工≠是 且 岗位列命中→仅餐补40；
  ③仅自动字段出现日→计0并出险情提示。
  断言：凡入“计工资集合”的任何一天若检测到“是否施工≠是”→Hard。
3）餐补：
  ①施工日25；
  ②待命日40；
  ③施工“未供餐”日提至40（同日+同车辆组+施工=是+备注命中；不跨组；待命不参与“未供餐”判断）。
  同日同车组25/40混用→险情提示。
4）单防撞判定（车组粒度｜更新）：
  · 准入人员：仅“防撞车驾驶员本人”，最多允许“本人+1辅助”；除驾驶员及其最多1名辅助外，其他任何人不得归入单防撞集合。
  · 判定：当日该车组岗位非空人数=1（仅驾驶员）或=2（驾驶员+1辅助）→该车组可判单防撞；否则（>2或组合不合法/无驾驶员）→该车组强制全组。
  · 工资单必须打印“单防撞判定=当日岗位人数=1/2/3/…（并注明是否为驾驶员本人/带1辅助）”。
  · 计价：仅当满足上述准入与人数条件时，可按单防撞口径；否则一律全组计价。
5）已付/预支/路补统一口径：
  · 预支仅两种：类别=工资预支；或备注“预支X天”并逐日分摊；预支=0两版不显示“预支”。
  · 已付（工资类强制）：类别=工资 且状态有效 且姓名匹配 → 必计入“已付工资”，并从应付中扣减；备注疑似跨项目不影响扣减，但必须在该笔明细行追加“险情：疑似跨项目/项目不明（仍已扣减）”。
  · 应付恒等式=工资+餐补+路补−已付（展示时零项省略）；路补有开关且不与路费类报销重复；每笔已付/预支明细行后追加“险情：无/凭证冲突/疑似路费进个人/同组不一致/组外扩散…”。
6）多人出单：先逐人详细版，最后集中输出压缩版。
7）跨项目：同一人命中≥2项目时，各项目标题必须带姓名；否则阻断/重排。
8）30秒核验（强制输出）：岗位列命中X天；仅自动字段命中Y天（不计）。Y>0须提示复核。
9）缺失项清单（显式列出，缺任一停止计算，仅输出提示）：①“点名归0/清零”触发关键词/字段；②“全组计价”的单价来源/映射字段；③“同车辆组”的唯一分组字段（车牌/车组ID/车组名等）。

14｜尾注（打印）
版本/打印：计算口径版本 v2025-11-25R52｜阻断模式：Hard

v2025-11-25R52-FixedDailyRates｜版本序号：#52｜阻断模式：Hard

附表A｜固定日薪映射（内置，只读）
- 说明：以下映射写入“个人单价_统一”，参与全组与单防撞的优先级拾取（见7.1/7.2）；不与角色默认冲突，优先级更高。
  · 王怀宇：300
  · 余步云：260
  · 董峰：300
  · 董祥：300
  · 王怀良：230
  · 袁玉兵：300
